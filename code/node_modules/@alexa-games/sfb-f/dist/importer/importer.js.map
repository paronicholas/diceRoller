{"version":3,"file":"importer.js","sourceRoot":"","sources":["../../importer/importer.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * abc-importer\n * \n * Imports and exports between various branched content formats and the Alexa Branching Content (ABC) format.\n */\n\nimport { DefaultFormatImportPlugin } from '../importPlugins/DefaultFormatImportPlugin';\nimport { AlexaABCVerifier } from \"../verificationHandlers/alexa-abc-verifier\";\nimport { ImportResult, ImportErrorLine, ImportError } from \"./importerEntity\";\nimport { ABCImportPlugin } from './../importPlugins/importerPlugin';\nimport { ABCExporter } from './../exportHandlers/exporter';\nimport { StoryMetadata, InstructionType } from './../story/storyMetadata';\nimport { ModelBuilder, AlexaVoiceModelBuilder } from '../bakeUtilities/VoiceModelBuilder';\nimport { BUILT_IN_INTENT_UTTERANCES as builtInIntents } from '../bakeUtilities/BuiltInIntents';\nimport { DriverExtension, ImporterExtension, InstructionExtension, isImporterExtension } from \"../extensions/ACEExtension\";\nimport { StoryMetadataHelper } from \"../importPlugins/storyMetadataHelper\";\nimport { SourceContentHelper } from \"../importPlugins/sourceContentHelper\";\n\nimport { readUtf8FileExcludingBomSync } from '@alexa-games/sfb-util';\n\nimport * as fs from \"fs\";\n\nexport interface ContentItem {\n    id?: string,\n    text: string\n}\n\ninterface ImportOption {\n\t/**\n\t * raw string of content to import.\n\t */\n\tcontent?: string;\n\t/**\n\t * list of contents to import as one story.\n\t */\n\tcontents?: ContentItem[];\n\t/**\n\t * content format version. default is 1\n\t */\n\tversion?: number;\n\t/**\n\t * importing locale\n\t */\n\tlocale?: string;\n\t/**\n\t * if true, the import does not throw on import error.\n\t */\n\tignoreSyntaxError?: boolean;\n\tmodelBuilder?: ModelBuilder;\n\tinvocationName?: string;\n\tcustomSlots?: {[key: string]: string[]};\n}\n\n\nexport class ACEImporter\n{\t\n\tstatic readonly fallBackEnabledLocales = [\n\t\t\"en\",\n\t\t\"de-DE\"\n\t];\n\n\timportHandlersByType : {[key: string] : ABCImportPlugin} = {};\n\t\n\texportHandlersByType : {[key: string] : ABCExporter} = {};\n\n\timportExtensions: (DriverExtension|ImporterExtension|InstructionExtension)[] = [];\n\n\tverifier : AlexaABCVerifier = new AlexaABCVerifier();\n\n\t// Constructor\n\tpublic constructor(customImporters?: ABCImportPlugin[], customerExporters?: {[key: string]: ABCExporter}, extensions?: (DriverExtension|ImporterExtension|InstructionExtension)[]) {\n\t\tlet importPlugins: ABCImportPlugin[] = [\n\t\t\tnew DefaultFormatImportPlugin()\n\t\t];\n\t\t\n\t\tif (customImporters) {\n\t\t\timportPlugins = importPlugins.concat(customImporters);\n\t\t}\n\n\t\tfor (let importPlug of importPlugins) {\n\t\t\tthis.importHandlersByType[importPlug.pluginName] = importPlug;\n\t\t}\n\n\t\tif (customerExporters) {\n\t\t\tObject.assign(this.exportHandlersByType, customerExporters);\n\t\t}\n\n\t\tif(extensions) {\n\t\t\tthis.importExtensions = extensions;\n\t\t}\n\t}\n\t\n\tpublic async importABCStory(format : string, filename : string, storyTitle: string, storyID: string, autoIntentGrouping?: boolean, param: ImportOption = {}): Promise<StoryMetadata> {\n\t\tlet contents: ContentItem[] = [];\n\n\t\tif (param.content) {\n\t\t\tcontents.push({\n\t\t\t\tid: \"default\",\n\t\t\t\ttext: param.content\n\t\t\t});\n\t\t} else if (param.contents) {\n\t\t\tcontents = param.contents;\n\t\t} else {\n\t\t\tcontents.push({\n\t\t\t\tid: filename,\n\t\t\t\ttext: readUtf8FileExcludingBomSync(filename)\n\t\t\t});\n\t\t}\n\t\t\n\n\t\tfor (let extension of this.importExtensions) {\n\t\t\tif (isImporterExtension(extension)) {\n\t\t\t\tconst sourceHelper = new SourceContentHelper(contents);\n\t\t\t\tawait extension.extendSourceContent(sourceHelper);\n\t\t\t\tparam.contents = sourceHelper.getAllSourceContents();\n\t\t\t}\n\t\t}\n\n\t\tlet importHandler : ABCImportPlugin = this.importHandlersByType[format];\n\n\t\tconst contentVersion: number = param.version || 1;\n\t\tconst optimalVersion = importHandler.getVersion();\n\t\tif (optimalVersion < contentVersion) {\n\t\t\tthrow new Error(`Unsupported Language Version: Importer expected content version ${optimalVersion}, but detected version ${contentVersion}.`);\n\t\t}\n\n\t\tlet thisObj = this;\n\t\tconst importResult: ImportResult = await importHandler.importData(contents, param);\n\t\tconst importedScenes = importResult.importedScenes;\n\t\tconst importErrors = importResult.errors || [];\n\n\t\tlet jsonObjOutput: StoryMetadata = {\n\t\t\tpluginName: importHandler.pluginName,\n\t\t\tscenes: importedScenes,\n\t\t\tstoryID: storyID,\n\t\t\tstoryTitle: storyTitle\n\t\t}\n\n\t\tfor (let extension of this.importExtensions) {\n\t\t\ttry {\n\t\t\t\tif (isImporterExtension(extension)) {\n\t\t\t\t\tconst metadataHelper = new StoryMetadataHelper(jsonObjOutput);\n\t\t\t\t\tawait extension.extendImportedContent(metadataHelper);\n\t\t\t\t\tjsonObjOutput = await metadataHelper.getStoryMetadata();\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tconst extensionError: ImportErrorLine = {\n\t\t\t\t\tlineNumber: 0,\t\t\t\t\t\t\n\t\t\t\t\terrorMessage: err,\n\t\t\t\t\terrorName: `Import Extension Error on ${extension.constructor.name}`\n\t\t\t\t};\n\n\t\t\t\timportErrors.push(extensionError);\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (!param.ignoreSyntaxError) {\n\t\t\tconst finalError = await thisObj.verifier.verify(jsonObjOutput);\n\t\t\tfinalError.forEach((errorItem) => {\n\t\t\t\timportErrors.push(errorItem);\n\t\t\t});\n\t\t}\n\n\t\ttry {\n\t\t\tlet modelBuilder: ModelBuilder;\n\t\t\tif (param.modelBuilder) {\n\t\t\t\tmodelBuilder = param.modelBuilder;\n\t\t\t} else {\n\t\t\t\tmodelBuilder = new AlexaVoiceModelBuilder();\n\t\t\t}\n\t\t\t\n\t\t\tconst locale = param.locale || \"en-US\";\n\t\t\tconst language: string = locale.split(\"-\")[0];\n\t\t\tconst storyHelper = new StoryMetadataHelper(jsonObjOutput);\n\t\t\tconst localizedBuiltIn = builtInIntents[locale] || builtInIntents[language];\n\n\t\t\tif (ACEImporter.fallBackEnabledLocales.includes(locale) || ACEImporter.fallBackEnabledLocales.includes(language)) {\n\t\t\t\tlocalizedBuiltIn[\"AMAZON.FallbackIntent\"] = [];\n\t\t\t}\n\n\t\t\tconst voiceModel = modelBuilder.build({\n\t\t\t\tcustomSlots: Object.assign(param.customSlots || {}),\n\t\t\t\tbuiltInIntents: localizedBuiltIn,\n\t\t\t\tinvocationName: jsonObjOutput.storyTitle,\n\t\t\t\tstory: storyHelper,\n\t\t\t\tlocale: locale,\n\t\t\t});\n\n\t\t\tconst finalStoryMetadata = await storyHelper.getStoryMetadata();\n\t\t\tif (autoIntentGrouping) {\n\t\t\t\tfinalStoryMetadata.alexaVoiceModel = voiceModel;\t\n\t\t\t} else {\n\t\t\t\tlet allUtterances: any = {};\n\n\t\t\t\tfor (let scene of finalStoryMetadata.scenes) {\n\t\t\t\t\tfor (let content of scene.contents) {\n\t\t\t\t\t\tif (content.sceneDirections) {\n\t\t\t\t\t\t\tfor (let direction of content.sceneDirections) {\n\t\t\t\t\t\t\t\tif (direction.directionType == InstructionType.CHOICE) {\n\t\t\t\t\t\t\t\t\tallUtterances[direction.parameters.utterances] = 1;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfinalStoryMetadata.alexaVoiceModel = Object.keys(allUtterances);\t\n\t\t\t}\n\n\t\t\tjsonObjOutput = finalStoryMetadata;\n\t\t} catch(err) {\n\t\t\tif (err instanceof Error) {\n\t\t\t\timportErrors.push({\n\t\t\t\t\terrorName: \"VoiceModelBuildError\",\n\t\t\t\t\tlineNumber: 0,\n\t\t\t\t\terrorMessage: err.message + \"\\n\" + err.stack\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\timportErrors.push({\n\t\t\t\t\terrorName: \"VoiceModelBuildError\",\n\t\t\t\t\tlineNumber: 0,\n\t\t\t\t\terrorMessage: err\n\t\t\t\t});\n\t\t\t}\n\t\t\t\n\t\t}\n\n\t\tif (importErrors && importErrors.length > 0) {\n\t\t\tthrow (<ImportError> {\n\t\t\t\terrorItems: importErrors,\n\t\t\t\timportedData: jsonObjOutput\n\t\t\t});\n\t\t} else {\n\t\t\treturn jsonObjOutput;\n\t\t}\n\t}\n\n\tpublic exportTo(format : string, filename : string, outputFilename : string) {\n\n\t\tlet fileData = readUtf8FileExcludingBomSync(filename);\n\n\t\tlet jsonInputObj = JSON.parse(fileData);\n\n\t\tlet exportHandler : ABCExporter = this.exportHandlersByType[format];\n\n\t\tconsole.log(this.exportHandlersByType);\n\n\t\texportHandler.exportData(jsonInputObj, function(outputData : {}) {\n\n\t\t\tconsole.log(\"Output Data:\");\n\t\t\tconsole.log(outputData);\n\t\t\n\t\t\tfs.writeFileSync(outputFilename, outputData);\n\t\t});\n\t}\n}\n"]}