{"version":3,"file":"configAccessor.js","sourceRoot":"","sources":["../src/configAccessor.ts"],"names":[],"mappings":"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","sourcesContent":["declare var process: any\n\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport { readUtf8FileExcludingBom } from '@alexa-games/sfb-util';\n\nimport * as _ from 'lodash';\n\nexport class ConfigAccessor {\n\n    static defaultStage = \"dev\";\n    static defaultLocale = \"en-us\";\n\n    private contentPath: string;\n\n    private deployedFlag?: boolean;\n\n    constructor(private abcConfig: any, contentPath: string) {\n        this.contentPath = path.resolve(contentPath);\n    }\n    public set deployed(value: boolean) {\n        this.deployedFlag = value;\n    }\n    setValue(keyName : string, val: any, stage? : string, locale? : string) : void {\n\n        // Force stage and locale to lowercase\n        stage = (stage) ? stage.toLowerCase() : stage;\n        locale = (locale) ? locale.toLowerCase() : locale;\n\n        if(stage && locale) {\n            _.set(this.abcConfig, stage + \"-\" + locale + \".\" + keyName, val);\n            return;\n        } \n\n        if(stage) {\n            _.set(this.abcConfig, stage + \".\" + keyName, val);\n            return;\n        }\n\n        if(locale) {\n            _.set(this.abcConfig, locale + \".\" + keyName, val);\n            return;\n        }\n\n        _.set(this.abcConfig, \"default.\" + keyName, val);\n        return;\n    }\n\n    public get askSkillDirectoryName() {\n        return this.getValue(\"ask-skill-directory-name\");\n    }\n\n    public get validResourceFileExtensions(): string[] {\n        return this.getValue(\"valid-resource-file-extensions\") || [\"json\", \"csv\"];\n    }\n\n    public get additionalResourceDirectories(): string[] {\n        return this.getValue(\"additional-resource-directories\") || [\"apl-templates\"];\n    }\n\n    public get publishLocales(): string[] {\n        return this.getValue(\"publish-locales\");\n    }\n\n    public getResourcePath(locale: string) {\n        \n        const resourcesPathWithLocaleAndResources = path.join(this.contentPath, locale, \"resources\");\n\n        if (this.deployedFlag === undefined) {\n            // If nothing has set the deployedFlag to a specific value, test for the \n            // presence of the resources folder. Don't set the deployedFlag based on this \n            // result because fs.existsSync will also return true if the locale is not available.\n            if(fs.existsSync(resourcesPathWithLocaleAndResources)) {\n                return resourcesPathWithLocaleAndResources;\n            }\n        } else if (this.deployedFlag === false) {\n            return resourcesPathWithLocaleAndResources\n        }\n       \n        return path.join(this.contentPath, locale);\n    }\n\n    public getS3ResourcesUri(locale: string): string {\n        return `https://${this.getS3DomainName(locale)}/${this.getS3BucketName(locale)}/${this.getAskSkillPath(locale)}/${locale}`;\n    }\n\n    public getS3DomainName(locale: string): string {\n        return this.getValue(\"s3-domain-name\", undefined, locale);\n    }\n\n    public getS3BucketName(locale: string): string {\n        return this.getValue(\"s3-bucket-name\", undefined, locale);\n    }\n\n    public getSnippetMapFilePath(locale: string): string {\n        return path.join(this.getResourcePath(locale), this.getValue(\"snippet-map-filename\", undefined, locale));;\n    }\n\n    public getAskSkillPath(locale: string): string {\n        return this.getValue(\"ask-skill-directory-name\", undefined, locale);\n    }\n\n    public shouldOverwriteWithSource(locale: string): boolean {\n        return this.getValue(\"update-string-with-source\", undefined, locale);\n    }\n\n    public getAplTemplatesFilePath(locale: string) {\n        return path.resolve(this.getResourcePath(locale), this.getValue(\"apl-templates-filename\", undefined, locale));\n    }\n\n    // Return \"\" for file path if apl-commands-filename does not exist\n    public getAplCommandsFilePath(locale: string) {\n        const aplCommandsFilename = this.getValue(\"apl-commands-filename\", undefined, locale);\n        return aplCommandsFilename ? path.resolve(this.getResourcePath(locale), aplCommandsFilename) : \"\";\n    }\n\n    getValue(keyName : string, stage? : string, locale? : string, skipLocaleMapping? : boolean, skillId? : string) : any {\n\n        // Force stage and locate to lowercase\n        stage = (stage) ? stage.toLowerCase() : stage;\n        locale = (locale) ? locale.toLowerCase() : locale;\n        \n        // If not specified, check for an environment variable and use it\n        if(!stage) {\n            stage = process.env.stage;\n            //console.log(\"Getting environment variable from: \" +  JSON.stringify(process.env) );\n        }\n\n        if(!locale) {\n            locale = process.env.locale;\n        }\n\n        // If still not specified, use a default value\n        if(!stage) {\n            stage = ConfigAccessor.defaultStage;\n        }\n\n        if(!locale) {\n            locale = ConfigAccessor.defaultLocale;\n        }\n\n        let mappedLocaleToUse = locale;\n        /*\n        // First map from given locale to mappedLocaleToUse\n        if(!skipLocaleMapping) {\n            // Need to make sure to set skipLocaleMapping to true to avoid a forever recursive loop\n            mappedLocaleToUse = ConfigHelper.getValue(\"localeToUse\", stage, locale, true);\n        }*/\n\n        let val : any = undefined;\n\n        // If skillId set, then try and lookup by it first\n        if(skillId) {\n            val = _.get(this.abcConfig, [skillId, keyName]);  // Don't use a string, because skill id includes dots, so instead use the lodash get array syntax\n            if(val) { return val; }                \n        }\n\n        // First lookup by stage and mappedLocaleToUse\n        val = _.get(this.abcConfig, stage + \"-\" + mappedLocaleToUse + \".\" + keyName);\n        if(val) { return val; }\n\n        // Then lookup by stage\n        val = _.get(this.abcConfig, stage + \".\" + keyName);\n        if(val) { return val; }\n\n        // Then lookup by mappedLocaleToUse\n        val = _.get(this.abcConfig, mappedLocaleToUse + \".\" + keyName);\n        if(val) { return val; }\n\n        // Then lookup by default\n        val = _.get(this.abcConfig, \"default.\" + keyName);\n        if(val) { return val; }\n        \n        return val;\n    }\n\n    public getRequestLocalizedValue(keyName : string, event : any) {\n        let locale = _.get(event, \"request.locale\");\n        let skillId = _.get(event, \"session.application.applicationId\");\n        //console.log(\"[DEBUG] ConfigHelper: getRequestLocalizedValue : Request locale=[ \" + locale + \"], SkillId=[\" + skillId + \"]\");\n\n        return this.getValue(keyName, undefined, locale, false, skillId);\n    }\n\n    public static async loadConfigFile(configFile: string, contentPath: string): Promise<ConfigAccessor> {\n        const data = await readUtf8FileExcludingBom(configFile);\n        return new ConfigAccessor(JSON.parse(data), contentPath);\n    }\n}\n"]}